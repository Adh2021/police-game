<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE COUNTY: SYNDICATE</title>
    <meta name="theme-color" content="#0d0d0d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root { --bg: #0d0d0d; --panel: #141414; --text: #c0c0c0; --green: #00ff41; --red: #ff3333; --blue: #00ccff; --amber: #ffb000; --purple: #bd00ff; --font: 'Courier New', monospace; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        
        /* LAYOUT & UTILS */
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; padding: 10px; }
        .screen.active { display: flex; }
        .scanlines { background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 99; }
        
        /* UI HEADER */
        .header { border-bottom: 2px solid var(--green); padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; font-size: 14px; text-transform: uppercase; align-items: center; }
        .gold-disp { color: var(--amber); font-weight: bold; font-size: 16px; }
        .relic-bar { display: flex; gap: 5px; overflow-x: auto; padding: 5px 0; height: 30px; align-items: center; }
        .relic { font-size: 18px; cursor: help; position: relative; }
        
        /* BUTTONS */
        button { background: var(--panel); border: 1px solid var(--green); color: var(--green); padding: 15px; font-family: var(--font); font-size: 16px; text-transform: uppercase; margin-bottom: 10px; width: 100%; cursor: pointer; transition: 0.1s; }
        button:active { background: var(--green); color: var(--bg); transform: scale(0.98); }
        button.secondary { border-color: #555; color: #888; }

        /* COMBAT UI */
        .combat-box { border: 1px solid #444; padding: 10px; margin-bottom: 10px; position: relative; transition: border-color 0.2s; }
        .combat-box.enemy { border-color: var(--red); text-align: center; }
        .combat-box.player { border-color: var(--blue); }
        .bar-bg { background: #330000; height: 8px; width: 100%; margin-top: 5px; position: relative; }
        .hp-bar { background: var(--red); height: 100%; width: 100%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .block-icon { color: var(--blue); font-weight: bold; }
        .status-row { font-size: 10px; margin-top: 5px; min-height: 12px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .status-badge { padding: 1px 3px; border-radius: 2px; background: #222; border: 1px solid #444; }

        /* CARDS */
        .hand-area { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; height: 160px; align-items: center; perspective: 1000px; }
        .card { 
            min-width: 95px; height: 130px; background: #050505; border: 1px solid #555; 
            display: flex; flex-direction: column; padding: 5px; font-size: 10px; position: relative; 
            transition: transform 0.15s; cursor: pointer; flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .card:active { transform: translateY(-15px) scale(1.05); z-index: 100; border-color: #fff; }
        .card.atk { border-color: var(--red); color: var(--red); }
        .card.skill { border-color: var(--blue); color: var(--blue); }
        .card.power { border-color: var(--amber); color: var(--amber); }
        .card.rare { border: 1px solid var(--purple); box-shadow: 0 0 5px var(--purple); }
        .card-cost { position: absolute; top: 2px; right: 5px; font-size: 16px; font-weight: bold; }
        .card-name { font-weight: bold; margin-bottom: 5px; font-size: 10px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 2px;}
        .card-desc { text-align: center; margin-top: auto; font-size: 9px; line-height: 1.2; color: #aaa; }

        /* MAP & SHOP */
        .map-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px 0; }
        .node { height: 90px; border: 1px dashed #444; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; text-align: center; cursor: pointer; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 20px; }
        .price-tag { color: var(--amber); font-weight: bold; text-align: center; margin-bottom: 5px; font-size: 12px; }

        /* FX */
        @keyframes shake { 0% { transform: translate(1px, 1px); } 20% { transform: translate(-3px, 0px); } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-3px, 1px); } 100% { transform: translate(0, 0); } }
        .shake { animation: shake 0.4s; }
        @keyframes floatUp { 0% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-30px); } }
        .float-text { position: absolute; font-weight: bold; font-size: 20px; animation: floatUp 0.8s forwards; pointer-events: none; z-index: 999; text-shadow: 1px 1px 0 #000; }
        
        #save-msg { position: absolute; bottom: 5px; right: 5px; font-size: 10px; color: #444; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div id="save-msg">AUTO-SAVED</div>

    <div id="screen-menu" class="screen active">
        <h1 style="color:var(--green); text-align: center; margin-top:30px;">THE COUNTY</h1>
        <div style="text-align: center; margin-bottom: 20px;">CHOOSE YOUR OFFICER</div>
        
        <button onclick="Game.init('interceptor')">
            THE INTERCEPTOR<br>
            <span style="font-size:10px; color:#888">Aggressive ‚Ä¢ Strength ‚Ä¢ Ramming</span>
        </button>
        
        <button onclick="Game.init('detective')">
            THE DETECTIVE<br>
            <span style="font-size:10px; color:#888">Defensive ‚Ä¢ Debuffs ‚Ä¢ Control</span>
        </button>

        <button class="secondary" id="btn-continue" onclick="Game.load()" style="display:none; margin-top:20px;">RESUME SHIFT</button>
        <button class="secondary" onclick="localStorage.clear(); location.reload()" style="margin-top:5px;">RESET DATA</button>
    </div>

    <div id="screen-map" class="screen">
        <div class="header">
            <span>SECTOR <span id="sector-disp">1</span></span>
            <span class="gold-disp">‚òÖ<span id="gold-disp">0</span></span>
        </div>
        <div class="relic-bar" id="relic-bar"></div>
        <div class="map-grid" id="map-nodes"></div>
    </div>

    <div id="screen-combat" class="screen">
        <div class="header">
            <span>INCIDENT</span>
            <span style="color:var(--amber)">‚ö° <span id="combat-energy">3</span></span>
        </div>
        
        <div id="enemy-area" class="combat-box enemy">
            <div style="font-size:24px; margin-bottom:5px;" id="enemy-intent">‚ö†Ô∏è</div>
            <div id="enemy-name" style="font-weight:bold; font-size:14px;">SUSPECT</div>
            <div class="bar-bg"><div class="hp-bar" id="enemy-hp-bar"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:10px;">
                <span id="enemy-hp-text">50/50</span>
                <span>RESISTANCE</span>
            </div>
            <div id="enemy-buffs" class="status-row" style="color:var(--amber);"></div>
        </div>

        <div id="player-area" class="combat-box player">
            <div style="display:flex; justify-content:space-between; font-size:10px;">
                <span>OFFICER</span>
                <span id="player-hp-text">50/50</span>
            </div>
            <div class="bar-bg" style="background:#111;"><div class="hp-bar" id="player-hp-bar" style="background:var(--green)"></div></div>
            <div style="margin-top:5px; font-weight:bold; color:var(--blue)">
                üõ°Ô∏è <span id="player-block">0</span> SAFETY
            </div>
            <div id="player-buffs" class="status-row" style="color:var(--green);"></div>
        </div>

        <div id="combat-log" style="font-size:10px; height:24px; overflow:hidden; color:#666; margin-top:5px; border-top:1px dashed #333;"></div>
        <div style="flex:1;"></div>
        <div class="hand-area" id="hand-container"></div>
        <button onclick="Game.endTurn()" style="margin-top:5px; padding:10px;">END TURN</button>
    </div>

    <div id="screen-reward" class="screen">
        <div class="header"><span>CASE CLOSED</span></div>
        <div style="text-align:center;">
            <h2 style="color:var(--green)">SUCCESS</h2>
            <p>Earned <span class="gold-disp">‚òÖ 25</span></p>
            <p>DRAFT NEW EQUIPMENT:</p>
        </div>
        <div class="reward-grid" id="reward-container" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;"></div>
        <button onclick="Game.showMap()" style="margin-top:auto;">CONTINUE</button>
    </div>

    <div id="screen-shop" class="screen">
        <div class="header"><span>SUPPLY DEPOT</span><span class="gold-disp">‚òÖ<span id="shop-gold">0</span></span></div>
        <div class="shop-grid" id="shop-container"></div>
        <button onclick="Game.showMap()" style="margin-top:auto;">LEAVE</button>
    </div>

<script>
/* ------------------------------------------------------------------
   1. DATA: CARDS & SYNERGIES
   ------------------------------------------------------------------ */
const CARDS = {
    // STARTING
    "strike": { name:"CITATION", cost:1, type:"atk", actions:[{type:"dmg", val:6}], desc:"Deal 6 Dmg." },
    "defend": { name:"LANE CTRL", cost:1, type:"skill", actions:[{type:"blk", val:5}], desc:"Gain 5 Safety." },
    
    // COMMON
    "bash":   { name:"PIT MANEUVER", cost:2, type:"atk", actions:[{type:"dmg", val:8}, {type:"sts", id:"vuln", val:2}], desc:"Deal 8. Apply 2 Vuln." },
    "taser":  { name:"TASER", cost:0, type:"atk", actions:[{type:"dmg", val:4}, {type:"sts", id:"weak", val:1}], desc:"Deal 4. Apply 1 Weak." },
    "shrug":  { name:"SHRUG IT OFF", cost:1, type:"skill", actions:[{type:"blk", val:8}, {type:"draw", val:1}], desc:"Gain 8 Safety. Draw 1." },
    "radio":  { name:"RADIO AHEAD", cost:1, type:"skill", actions:[{type:"draw", val:3}], desc:"Draw 3 Cards." },
    
    // UNCOMMON (BUILD MAKERS)
    "clothesline": { name:"CLOTHESLINE", cost:2, type:"atk", actions:[{type:"dmg", val:12}, {type:"sts", id:"weak", val:2}], desc:"Deal 12. Apply 2 Weak." },
    "spot_weak":   { name:"SPOT WEAKNESS", cost:1, type:"skill", actions:[{type:"cond_buff", id:"str", val:3}], desc:"If Enemy intends Atk, gain 3 Str." },
    "body_slam":   { name:"BODY SLAM", cost:1, type:"atk", actions:[{type:"special", id:"slam"}], desc:"Deal Dmg equal to your Safety." },
    "entrench":    { name:"ENTRENCH", cost:2, type:"skill", actions:[{type:"special", id:"double_blk"}], desc:"Double your Safety." },
    
    // RARE (POWER SPIKES)
    "demon":   { name:"DEMON FORM", cost:3, type:"power", actions:[{type:"buff", id:"rit", val:2}], desc:"At start of turn, gain 2 Str.", rare:true },
    "echo":    { name:"ADRENALINE", cost:0, type:"skill", actions:[{type:"eng", val:2}, {type:"draw", val:2}], desc:"Gain 2 Energy. Draw 2.", rare:true, exhaust:true },
    "bludgeon":{ name:"BLUDGEON", cost:3, type:"atk", actions:[{type:"dmg", val:32}], desc:"Deal 32 Dmg.", rare:true }
};

const RELICS = {
    "badge": { name:"Badge", icon:"‚≠ê", desc:"Heal 4 HP after combat." },
    "donut": { name:"Donut", icon:"üç©", desc:"Max HP +5. Start combat with +1 Str." },
    "anchor":{ name:"Anchor", icon:"‚öì", desc:"Start combat with 10 Safety." },
    "pen":   { name:"Pen",    icon:"üñäÔ∏è", desc:"Every 10th card played deals double damage." },
    "siren": { name:"Siren",  icon:"üì¢", desc:"Enemies start with 1 Weak." }
};

const ENEMIES = {
    1: [{n:"SPEEDER", hp:22, dmg:6}, {n:"DRUNK", hp:25, dmg:5, wk:1}, {n:"TEEN", hp:20, dmg:8}],
    2: [{n:"KAREN", hp:44, dmg:7}, {n:"TEXTER", hp:40, dmg:10}, {n:"RAGER", hp:50, dmg:5, str:1}],
    3: [{n:"ROBBER", hp:75, dmg:12}, {n:"TRUCK", hp:90, dmg:8, th:3}],
    boss: [{n:"THE CHIEF", hp:160, dmg:12}, {n:"TANKER", hp:140, dmg:15}]
};

/* ------------------------------------------------------------------
   2. GAME ENGINE
   ------------------------------------------------------------------ */
const Game = {
    state: {},
    audioCtx: null,

    // AUDIO
    initAudio: () => { if(!Game.audioCtx) Game.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); },
    sfx: (t) => {
        if(!Game.audioCtx) return;
        if(Game.audioCtx.state === 'suspended') Game.audioCtx.resume();
        const ctx = Game.audioCtx, osc = ctx.createOscillator(), g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        const time = ctx.currentTime;
        if(t==='hit'){osc.type='square';osc.frequency.setValueAtTime(150,time);osc.frequency.exponentialRampToValueAtTime(40,time+0.1);g.gain.setValueAtTime(0.1,time);g.gain.linearRampToValueAtTime(0,time+0.1);}
        if(t==='blk'){osc.type='triangle';osc.frequency.setValueAtTime(300,time);g.gain.setValueAtTime(0.1,time);g.gain.linearRampToValueAtTime(0,time+0.1);}
        if(t==='ui'){osc.type='sine';osc.frequency.setValueAtTime(800,time);g.gain.setValueAtTime(0.05,time);g.gain.linearRampToValueAtTime(0,time+0.05);}
        osc.start(time); osc.stop(time+0.15);
    },

    // FX
    fx: (id, txt, color) => {
        const el = document.getElementById(id);
        if(color) {
            const f = document.createElement('div'); f.className='float-text'; f.innerText=txt; f.style.color=color;
            const r = el.getBoundingClientRect(); f.style.left=(r.left+r.width/2-10)+'px'; f.style.top=(r.top+10)+'px';
            document.body.appendChild(f); setTimeout(()=>f.remove(),800);
        }
        el.classList.remove('shake'); void el.offsetWidth; el.classList.add('shake');
    },

    // INIT
    init: (cls) => {
        Game.initAudio(); Game.sfx('ui');
        const hp = cls==='interceptor' ? 60 : 50;
        const deck = cls==='interceptor' 
            ? ["strike","strike","strike","strike","bash","defend","defend","defend","defend"]
            : ["strike","strike","strike","defend","defend","defend","defend","taser","shrug"];
        
        Game.state = {
            player: { hp:hp, maxHp:hp, blk:0, en:3, maxEn:3, str:0, dex:0, rit:0 },
            enemy: { hp:0, maxHp:0, intent:{}, weak:0, vuln:0, str:0 },
            deck: deck, hand: [], discard: [], exhaust: [], relics: [],
            turn: 1, sector: 1, prog: 0, gold: 50, penCounter: 0
        };
        Game.save(); Game.showMap();
    },

    // MAP
    showMap: () => {
        Game.state.screen = 'map'; Game.save(); Game.showScreen('map');
        document.getElementById('gold-disp').innerText = Game.state.gold;
        document.getElementById('sector-disp').innerText = Game.state.sector;
        
        const rBar = document.getElementById('relic-bar'); rBar.innerHTML = "";
        Game.state.relics.forEach(r => { 
            const d = document.createElement('div'); d.className='relic'; d.innerText=RELICS[r].icon; d.title=RELICS[r].desc; rBar.appendChild(d);
        });

        const grid = document.getElementById('map-nodes'); grid.innerHTML = "";
        if(Game.state.prog >= 6) {
             const n = document.createElement('div'); n.className='node'; n.style.borderColor='var(--purple)'; n.innerHTML=`<div style="font-size:30px">üíÄ</div>BOSS`; n.onclick=()=>Game.enter('BOSS'); grid.appendChild(n); return;
        }
        const types = ["COMBAT","COMBAT","COMBAT","SHOP"];
        for(let i=0;i<3;i++) {
            const t = types[Math.floor(Math.random()*types.length)];
            const n = document.createElement('div'); n.className='node'; n.style.borderColor=t==='COMBAT'?'var(--red)':'var(--amber)'; 
            n.innerHTML = `<div style="font-size:24px">${t==='COMBAT'?'üëÆ':'üõí'}</div>${t}`;
            n.onclick=()=>Game.enter(t); grid.appendChild(n);
        }
    },
    enter: (t) => { Game.sfx('ui'); if(t==='COMBAT'||t==='BOSS') Game.combat(t==='BOSS'); if(t==='SHOP') Game.shop(); },

    // SHOP
    shop: () => {
        Game.state.screen = 'shop'; Game.showScreen('shop');
        document.getElementById('shop-gold').innerText = Game.state.gold;
        const grid = document.getElementById('shop-container'); grid.innerHTML = "";
        
        // 1 Relic
        const rKeys = Object.keys(RELICS); const rId = rKeys[Math.floor(Math.random()*rKeys.length)];
        const rDiv = document.createElement('div'); rDiv.className='card'; rDiv.innerHTML=`<div style="font-size:30px;text-align:center;margin-top:20px">${RELICS[rId].icon}</div><div class="card-name">${RELICS[rId].name}</div><div class="card-desc">${RELICS[rId].desc}</div>`;
        const rPrice = document.createElement('div'); rPrice.className='price-tag'; rPrice.innerText="100 ‚òÖ";
        rDiv.onclick=()=>{ if(Game.state.gold>=100 && !Game.state.relics.includes(rId)){Game.state.gold-=100;Game.state.relics.push(rId);Game.sfx('ui');Game.showMap();} };
        const wrap = document.createElement('div'); wrap.appendChild(rPrice); wrap.appendChild(rDiv); grid.appendChild(wrap);

        // 3 Cards
        const pool = ["clothesline","spot_weak","body_slam","entrench","demon","echo","bludgeon"];
        for(let i=0;i<3;i++) {
            const cid = pool[Math.floor(Math.random()*pool.length)];
            const div = document.createElement('div'); Game.renderCard(cid, div, ()=>{ if(Game.state.gold>=50){Game.state.gold-=50;Game.state.deck.push(cid);Game.sfx('ui');Game.showMap();} });
            const p = document.createElement('div'); p.className='price-tag'; p.innerText="50 ‚òÖ";
            const w = document.createElement('div'); w.appendChild(p); w.appendChild(div); grid.appendChild(w);
        }
    },

    // COMBAT LOOP
    combat: (isBoss) => {
        const s = Game.state; s.screen = 'combat';
        const pool = isBoss ? ENEMIES['boss'] : (ENEMIES[s.sector] || ENEMIES[1]);
        const t = pool[Math.floor(Math.random()*pool.length)];
        s.enemy = { ...t, maxHp:t.hp, blk:0, weak:0, vuln:0, intent:{}, str: t.str||0 };
        // Relic Triggers
        if(s.relics.includes('anchor')) s.player.blk = 10;
        if(s.relics.includes('donut')) s.player.str += 1;
        if(s.relics.includes('siren')) s.enemy.weak = 1;
        
        s.hand=[]; s.discard=[]; s.exhaust=[]; s.deck=[...Game.state.deck].sort(()=>Math.random()-0.5);
        Game.showScreen('combat'); Game.intent(); Game.turn(); Game.save();
    },

    turn: () => {
        const p = Game.state.player; p.blk = 0; p.en = p.maxEn;
        if(p.rit) p.str += p.rit; // Demon Form trigger
        Game.draw(5); Game.ui();
    },

    draw: (n) => {
        for(let i=0;i<n;i++) {
            if(Game.state.deck.length===0){ if(Game.state.discard.length===0)break; Game.state.deck=Game.state.discard.sort(()=>Math.random()-0.5); Game.state.discard=[]; }
            if(Game.state.deck.length>0) Game.state.hand.push(Game.state.deck.pop());
        }
        Game.renderHand();
    },

    play: (idx) => {
        const s = Game.state; const cid = s.hand[idx]; const d = CARDS[cid];
        if(s.player.en < d.cost) return; // Not enough energy
        s.player.en -= d.cost; s.hand.splice(idx,1);

        // Relic: Pen Nib (Double dmg every 10th card)
        if(s.relics.includes('pen')) s.penCounter++;
        const isDouble = s.relics.includes('pen') && s.penCounter >= 10;
        if(isDouble) { s.penCounter=0; Game.fx('player-area', "PEN NIB!", "var(--purple)"); }

        d.actions.forEach(a => {
            if(a.type==='dmg') {
                let v = a.val + s.player.str;
                if(s.enemy.vuln) v = Math.floor(v*1.5);
                if(s.player.weak) v = Math.floor(v*0.75);
                if(isDouble) v *= 2;
                s.enemy.hp -= v;
                Game.sfx('hit'); Game.fx('enemy-area', "-"+v, "var(--red)");
            }
            if(a.type==='blk') { let v = a.val + s.player.dex; s.player.blk += v; Game.sfx('blk'); Game.fx('player-area', "+"+v, "var(--blue)"); }
            if(a.type==='sts') s.enemy[a.id] = (s.enemy[a.id]||0) + a.val;
            if(a.type==='buff') s.player[a.id] += a.val;
            if(a.type==='draw') Game.draw(a.val);
            if(a.type==='eng') s.player.en += a.val;
            if(a.type==='cond_buff' && s.enemy.intent.type==='atk') s.player[a.id] += a.val;
            if(a.type==='special' && a.id==='slam') { let v = s.player.blk; s.enemy.hp -= v; Game.sfx('hit'); Game.fx('enemy-area', "-"+v, "var(--red)"); }
            if(a.type==='special' && a.id==='double_blk') s.player.blk *= 2;
        });

        if(d.exhaust) s.exhaust.push(cid); else s.discard.push(cid);
        Game.renderHand(); Game.ui();
        if(s.enemy.hp <= 0) Game.win();
    },

    end: () => {
        Game.state.discard.push(...Game.state.hand); Game.state.hand=[]; Game.renderHand();
        const e = Game.state.enemy; const p = Game.state.player;
        
        if(e.intent.type==='atk') {
            let v = e.intent.val;
            if(e.weak) v = Math.floor(v*0.75);
            if(p.vuln) v = Math.floor(v*1.5);
            let blocked = Math.min(v, p.blk);
            v -= blocked;
            if(v > 0) { p.hp -= v; Game.sfx('hit'); Game.fx('player-area', "-"+v, "var(--red)"); }
            else { Game.sfx('blk'); }
        } else {
            if(e.intent.type==='buff') e.str += 2;
            if(e.intent.type==='debuff') p.weak += 2;
        }

        if(e.weak) e.weak--; if(e.vuln) e.vuln--;
        if(p.hp<=0) { localStorage.clear(); alert("OFFICER DOWN"); location.reload(); }
        else { Game.intent(); Game.turn(); }
    },

    intent: () => {
        const e = Game.state.enemy;
        const roll = Math.random();
        // Enemy Logic
        if(roll < 0.6) e.intent = { type:'atk', val: e.dmg + e.str + (Game.state.sector*2) };
        else if (roll < 0.8) e.intent = { type:'buff', val:0 };
        else e.intent = { type:'debuff', val:0 };
        Game.ui();
    },

    win: () => {
        Game.state.gold += 20; Game.state.prog++; Game.sfx('ui');
        // Relic: Badge Heal
        if(Game.state.relics.includes('badge')) { Game.state.player.hp = Math.min(Game.state.player.hp+4, Game.state.player.maxHp); Game.fx('player-area', "+4 HP", "var(--green)"); }
        
        // Deck Rebuild
        Game.state.deck.push(...Game.state.hand, ...Game.state.discard, ...Game.state.exhaust);
        Game.state.hand=[]; Game.state.discard=[]; Game.state.exhaust=[];

        if(Game.state.enemy.type === 'boss') {
            alert("SECTOR CLEARED"); Game.state.sector++; Game.state.prog=0;
            if(Game.state.sector>3) { alert("YOU WON!"); localStorage.clear(); location.reload(); return; }
        }

        Game.save();
        // Rewards
        const c = document.getElementById('reward-container'); c.innerHTML="";
        const drops = ["bash","shrug","clothesline","spot_weak","body_slam","entrench","demon","echo","bludgeon"];
        for(let i=0;i<3;i++){
            const cid = drops[Math.floor(Math.random()*drops.length)];
            Game.renderCard(cid, c, ()=>{ Game.state.deck.push(cid); Game.showMap(); });
        }
        Game.showScreen('reward');
    },

    // RENDER
    renderCard: (id, parent, click) => {
        const d = CARDS[id];
        const el = document.createElement('div'); el.className=`card ${d.type} ${d.rare?'rare':''}`; el.onclick=click;
        el.innerHTML = `<div class="card-cost">${d.cost}</div><div class="card-name">${d.name}</div><div class="card-desc">${d.desc}</div>`;
        parent.appendChild(el);
    },
    renderHand: () => {
        const c = document.getElementById('hand-container'); c.innerHTML="";
        Game.state.hand.forEach((cid,i)=>Game.renderCard(cid, c, ()=>Game.play(i)));
    },
    ui: () => {
        const p = Game.state.player; const e = Game.state.enemy;
        document.getElementById('player-hp-text').innerText=`${p.hp}/${p.maxHp}`;
        document.getElementById('player-hp-bar').style.width=(p.hp/p.maxHp*100)+'%';
        document.getElementById('player-block').innerText=p.blk;
        document.getElementById('combat-energy').innerText=p.en;
        document.getElementById('player-buffs').innerHTML = `<span class="status-badge" style="color:salmon">STR ${p.str}</span>` + (p.rit?`<span class="status-badge" style="color:purple">RIT ${p.rit}</span>`:'');

        if(e.hp>0) {
            document.getElementById('enemy-hp-text').innerText=`${e.hp}/${e.maxHp}`;
            document.getElementById('enemy-hp-bar').style.width=(e.hp/e.maxHp*100)+'%';
            document.getElementById('enemy-intent').innerText = e.intent.type==='atk' ? `‚ö†Ô∏è${e.intent.val}` : (e.intent.type==='buff'?'üí™':'üí¢');
            document.getElementById('enemy-name').innerText=e.n;
            let txt = "";
            if(e.vuln) txt+=`<span class="status-badge">VULN ${e.vuln}</span> `;
            if(e.weak) txt+=`<span class="status-badge">WEAK ${e.weak}</span> `;
            if(e.str) txt+=`<span class="status-badge" style="color:salmon">STR ${e.str}</span> `;
            document.getElementById('enemy-buffs').innerHTML = txt;
        }
    },
    showScreen: (id) => { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById('screen-'+id).classList.add('active'); },
    load: () => { Game.state=JSON.parse(localStorage.getItem('sheriff_save')); if(Game.state.screen==='combat'){Game.showScreen('combat');Game.ui();Game.renderHand();}else{Game.showMap();} },
    checkSave: () => { if(localStorage.getItem('sheriff_save')) document.getElementById('btn-continue').style.display='block'; }
};

Game.checkSave();
</script>
</body>
</html>
